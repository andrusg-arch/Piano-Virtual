<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Piano Virtual ‚Äî Andr√©s Giraldo (Blacks fixed)</title>
<style>
  /* Evitar copiar/pegar en nombres de las notas */
.white .lbl, .black .lbl {
  user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
  -moz-user-select: none;
  -webkit-touch-callout: none; /* iOS: evita el men√∫ de copiar/pegar */
  pointer-events: none;        /* el texto no captura el toque, la tecla s√≠ */
}

/* Quitar highlight t√°ctil molesto */
.white, .black {
  -webkit-tap-highlight-color: transparent;
}
:root{
  --bg:#071126; --panel:#0b2330; --muted:#9fb0bd; --accent:#00d4b4;
  --white:#fffdf6; --white-edge:#d4cec4; --black:#0b0f12;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#021018);color:#e6f4f2;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
.app{max-width:1200px;margin:18px auto;padding:14px;display:flex;flex-direction:column;gap:12px}
.header{display:flex;justify-content:space-between;align-items:start;gap:12px}
h1{margin:0;font-size:20px}
.subtitle{margin:4px 0 0;color:var(--muted);font-size:13px}
.controls{display:flex;gap:10px;flex-wrap:wrap;background:var(--panel);padding:10px;border-radius:12px}
.control-group{display:flex;flex-direction:column;gap:6px;color:var(--muted);font-size:13px}
select,input[type=range],button{background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit;padding:8px;border-radius:8px}
button.primary{background:var(--accent);color:#012;border:none;font-weight:700}
.keyboard-wrap{background:linear-gradient(180deg,#041427,#021018);padding:12px;border-radius:12px}
.keyboard{position:relative;width:100%;overflow-x:auto;border-radius:8px;padding:8px}
.white-keys{display:flex;gap:0;align-items:flex-end;height:320px;position:relative}
.white{width:64px;height:100%;background:var(--white);border-left:1px solid var(--white-edge);border-right:1px solid var(--white-edge);border-bottom:12px solid #ddd;border-radius:6px 6px 0 0;position:relative;z-index:1;display:flex;align-items:flex-end;justify-content:center;cursor:pointer}
.white .lbl{font-size:11px;color:#222;padding:6px}
.white.pressed{background:linear-gradient(180deg,#fff8d6,#fff3c9);transform:translateY(4px)}
.black-container{position:absolute;top:8px;left:8px;right:8px;bottom:0;pointer-events:none} /* container for black keys - absolute over whites */
.black{position:absolute;width:19px;height:58%;background:var(--black);border-radius:0 0 6px 6px;z-index:3;display:flex;align-items:flex-end;justify-content:center;color:#fff;cursor:pointer;pointer-events:auto;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
.black .lbl{font-size:11px;padding:6px}
.black.pressed{background:#222;transform:translateY(4px)}
.legend{display:flex;justify-content:space-between;color:var(--muted);font-size:13px;margin-top:8px}
.footer{margin-top:8px;color:var(--muted);font-size:13px;text-align:center}
.social a{color:var(--accent);text-decoration:none;margin:0 8px}
@media (max-width:900px){ .white{width:48px} .black{width:19px} .white-keys{height:260px} }
@media (max-width:560px){ .white{width:40px} .white-keys{height:220px} .controls{gap:8px} }
</style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div>
        <h1>üéπ Piano Virtual ‚Äî Andr√©s Giraldo</h1>
        <div class="subtitle">5 octavas ‚Ä¢ Polifon√≠a ‚Ä¢ Sustain ‚Ä¢ Voces ‚Ä¢ ADSR ‚Ä¢ Reverb</div>
      </div>
      <div style="text-align:right">
        <div class="small">Dise√±o y c√≥digo: <strong>Andr√©s Giraldo</strong></div>
        <div class="small social">Instagram: <a href="https://instagram.com/andres._.sgiraldo" target="_blank">@andres._.sgiraldo</a> ‚Ä¢ TikTok: <a href="https://tiktok.com/@andru_gs" target="_blank">@andru_gs</a></div>
      </div>
    </div>

    <div class="controls" role="region" aria-label="Controles">
      <div class="control-group"><label class="small">Voz</label><select id="voiceSelect"><option value="piano">Piano-like</option><option value="electric">Electric</option><option value="pad">Pad</option><option value="sine">Pure Sine</option></select></div>
      <div class="control-group"><label class="small">Volumen</label><input id="masterVol" type="range" min="0" max="1" step="0.01" value="0.88"></div>
      <div class="control-group"><label class="small">Attack</label><input id="attack" type="range" min="0.001" max="0.5" step="0.001" value="0.008"></div>
      <div class="control-group"><label class="small">Release</label><input id="release" type="range" min="0.02" max="2.0" step="0.01" value="0.18"></div>
      <div class="control-group"><label class="small">Reverb</label><input id="reverb" type="range" min="0" max="0.8" step="0.01" value="0.12"></div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center"><button id="sustainBtn">Sustain: off</button><button id="resetBtn" class="primary">Reset</button></div>
    </div>

    <div class="keyboard-wrap" role="application" aria-label="Piano">
      <div id="keyboard" class="keyboard" tabindex="0" aria-label="Piano keyboard">
        <div id="whiteContainer" class="white-keys" aria-hidden="false"></div>
        <div id="blackContainer" class="black-container" aria-hidden="false"></div>
      </div>
      <div class="legend"><div>Rango: <strong>C2 ‚Üí B6</strong> (5 octavas)</div><div class="small">Barra espacio = sustain ‚Ä¢ Teclado Q..P / A..L / Z..M</div></div>
    </div>

    <div class="footer">p√°gina de prueba <code>piano_andres_black_fixed.html</code>. Para codigo html.</div>
  </div>

<script>
/* Fixed: black keys on separate container and positioned relative to white keys.
   Keeps previous features. */

const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioCtx();
const masterGain = audioCtx.createGain();
masterGain.gain.value = 0.88;
masterGain.connect(audioCtx.destination);

const reverbGain = audioCtx.createGain();
const delay = audioCtx.createDelay();
const feedback = audioCtx.createGain();
const reverbLP = audioCtx.createBiquadFilter();
delay.delayTime.value = 0.08;
feedback.gain.value = 0.35;
reverbLP.type = 'lowpass';
reverbLP.frequency.value = 3000;
reverbGain.gain.value = 0.12;

// connect reverb chain and master
reverbGain.connect(delay);
delay.connect(feedback);
feedback.connect(reverbLP);
reverbLP.connect(masterGain);
masterGain.disconnect();
masterGain.connect(audioCtx.destination);
masterGain.connect(reverbGain);

// UI refs
const whiteContainer = document.getElementById('whiteContainer');
const blackContainer = document.getElementById('blackContainer');
const keyboardEl = document.getElementById('keyboard');
const voiceSelect = document.getElementById('voiceSelect');
const attackEl = document.getElementById('attack');
const releaseEl = document.getElementById('release');
const masterVol = document.getElementById('masterVol');
const sustainBtn = document.getElementById('sustainBtn');
const reverbEl = document.getElementById('reverb');
const resetBtn = document.getElementById('resetBtn');

masterVol.addEventListener('input', ()=> masterGain.gain.value = parseFloat(masterVol.value));
reverbEl.addEventListener('input', ()=> reverbGain.gain.value = parseFloat(reverbEl.value));
document.addEventListener('pointerdown', function resumeAudio(){ if(audioCtx.state === 'suspended') audioCtx.resume(); document.removeEventListener('pointerdown', resumeAudio); });
// evitar men√∫ contextual y selecci√≥n por largo toque
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('selectstart', e => e.preventDefault());
// notes build
const semitones = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const notes = [];
const startOct = 2;
const octCount = 5; // C2..B6
for(let o = startOct; o < startOct + octCount; o++){
  for(let i=0;i<12;i++){
    const name = semitones[i] + o;
    const midi = (o + 1) * 12 + i;
    const freq = 440 * Math.pow(2, (midi - 69)/12);
    notes.push({name,midi,freq,isSharp: semitones[i].includes('#'), semi:i});
  }
}

// create whites
whiteContainer.innerHTML = '';
const whiteEls = [];
for(let i=0;i<notes.length;i++){
  if(!notes[i].isSharp){
    const w = document.createElement('div');
    w.className = 'white';
    w.dataset.semiIndex = i; // semitone index
    w.dataset.index = i;
    w.dataset.note = notes[i].name;
    const lbl = document.createElement('div'); lbl.className='lbl'; lbl.textContent = notes[i].name;
    w.appendChild(lbl);
    whiteContainer.appendChild(w);
    whiteEls.push(w);
  }
}

// create blacks into blackContainer (absolute)
blackContainer.innerHTML = '';
for(let i=0;i<notes.length;i++){
  if(notes[i].isSharp){
    const b = document.createElement('div');
    b.className = 'black';
    b.dataset.semiIndex = i;
    b.dataset.index = i;
    b.dataset.note = notes[i].name;
    const lbl = document.createElement('div'); lbl.className='lbl'; lbl.textContent = notes[i].name;
    b.appendChild(lbl);
    blackContainer.appendChild(b);
  }
}

// position blacks relative to whites
function positionBlackKeys(){
  const whites = Array.from(whiteContainer.children);
  if(whites.length === 0) return;
  const blackEls = Array.from(blackContainer.children);
  const whiteWidth = whites[0].getBoundingClientRect().width;
  // set blackContainer left = whiteContainer offsetLeft (both inside keyboard)
  const wcRect = whiteContainer.getBoundingClientRect();
  const kbRect = keyboardEl.getBoundingClientRect();
  const offsetLeft = whiteContainer.offsetLeft; // relative to keyboardEl
  // position each black:
  blackEls.forEach(b=>{
    const semiIdx = parseInt(b.dataset.semiIndex,10);
    // count whites before this semitone
    const whitesBefore = notes.slice(0, semiIdx).filter(n=>!n.isSharp).length;
    // the black should be between whitesBefore-1 and whitesBefore
    let left = 0;
    if(whitesBefore > 0){
      // reference white to the left of the gap
      const leftWhite = whites[whitesBefore-1];
      left = leftWhite.offsetLeft + leftWhite.offsetWidth - (b.offsetWidth/2);
    } else {
      left = whites[0].offsetLeft - (b.offsetWidth/2);
    }
    b.style.left = Math.round(left) + 'px';
  });
}
setTimeout(positionBlackKeys, 80);
window.addEventListener('resize', ()=> setTimeout(positionBlackKeys, 80));

// ---------- Reproducci√≥n con samples ----------
const sampleNames = ["C2","C3","C4","C5","C6"];
const samples = {};
let samplesLoaded = false;

// Cargar audios desde el mismo directorio que index.html
async function loadSamples(){
  for(const name of sampleNames){
    const resp = await fetch(name + ".mp3");
    const arrayBuffer = await resp.arrayBuffer();
    samples[name] = await audioCtx.decodeAudioData(arrayBuffer);
  }
  samplesLoaded = true;
  console.log("Samples cargados üéµ");
}
loadSamples();

// Guardar frecuencia de cada sample
const sampleFreq = {};
sampleNames.forEach(n => {
  const found = notes.find(x => x.name === n);
  sampleFreq[n] = found ? found.freq : 440;
});

// Elegir sample m√°s cercano a la nota
function getClosestSample(noteName){
  const noteObj = notes.find(n=>n.name===noteName);
  if(!noteObj) return sampleNames[0];
  const freq = noteObj.freq;
  let closest = sampleNames[0];
  let minDiff = Infinity;
  for(const s of sampleNames){
    const diff = Math.abs(sampleFreq[s] - freq);
    if(diff < minDiff){ minDiff = diff; closest = s; }
  }
  return closest;
}

// Notas activas
const activeVoices = new Map();

// Al presionar tecla
function noteOn(idx, velocity=1){
  if(activeVoices.has(idx)) return;
  const n = notes[idx];
  if(!samplesLoaded) return;

  const closest = getClosestSample(n.name);
  const buffer = samples[closest];
  if(!buffer) return;

  const source = audioCtx.createBufferSource();
  source.buffer = buffer;
  source.playbackRate.value = n.freq / sampleFreq[closest];

  const gainNode = audioCtx.createGain();
  gainNode.gain.value = velocity;

  source.connect(gainNode).connect(masterGain);
  source.start();

  activeVoices.set(idx, {source, gainNode});
  markKey(idx, true);
}

// Al soltar tecla
function noteOff(idx){
  const v = activeVoices.get(idx);
  if(!v) return;
  try{ v.source.stop(); }catch(e){}
  activeVoices.delete(idx);
  markKey(idx, false);
}

// Bot√≥n reset
resetBtn.addEventListener('click', ()=>{
  activeVoices.forEach((v, idx)=>{
    try{ v.source.stop(); }catch(e){}
    activeVoices.delete(idx);
    markKey(idx,false);
  });
});

console.log('üéπ Piano con samples listo');
</script>
</body>
</html>
